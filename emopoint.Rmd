---
title: "Emopoint"
author: "Manuel Bohn"
date: "24 2 2018"
output:
  html_document: default
---

```{r load_packages, include = FALSE}
library("lme4")
library("ggplot2")
library("tidyverse")
library("ggthemes")
library("skimr")
library("lsr")
library("langcog")


#### loading data
data <- read.csv("data/emopoint.data.csv", sep=",")
str(data)
```
# Demographics summary
```{r participant ovrview, echo = FALSE}
data %>%
  filter (trial == "1") %>%
  group_by(study,phase,age, type) %>%
  arrange(study, age) %>%
  summarise(m_age = mean(aged)/30.42,
            sd_age = sd(aged)/30.42,
            ll_age = min(aged)/30.42,
            ul_age = max(aged)/30.42,
            sex_m = sum (sex)) %>%
  knitr::kable(digits = 2)
```

# Comparing performance to chance

Two tailed one sample t-tests for group level comparison. 
Individual performance: Above chance = all trials correct, below chance = all trials incorrect. This corresponds to p > .05 for two-tailed binomial test.
```{r chance performance, echo = FALSE}
t <- data %>%
  group_by(study,phase,age, type, id) %>%
  arrange(study, age) %>%
  summarise(corr = mean(corr)) %>%
  summarise(corr = list(corr)) %>%
  group_by(study,phase,age, type) %>%
  mutate(m = mean(unlist(corr)),
         sd = sd(unlist(corr)),
         df= t.test(unlist(corr), mu = 0.5)$parameter,
         t_value = t.test(unlist(corr), mu = 0.5)$statistic,
         p = t.test(unlist(corr), mu = 0.5)$p.value,
         d = cohensD(unlist(corr), mu = 0.5))%>%
  select(age,phase,type,m,sd,t_value,df,p,d) 

iac <- data %>%
  group_by(study,phase,age, type, id) %>%
  arrange(study,phase,age, type) %>%
  summarise(corr = mean(corr)) %>%
  summarise(below=length(corr[corr<=0]),above=length(corr[corr>=1]))

# Joining the two tables
ts <- t
ts$below <- iac$below
ts$above <- iac$above

# Overview
ts %>%
  knitr::kable(digits = 2)

```

# Study 1

For all models we used maximal random effect structure (`(trial|id)`). If model does not converge, correlation between random effects is removed and then random slope.

```{r study 1}
### control element used for all models
contr=glmerControl(optimizer="bobyqa", optCtrl=list(maxfun=100000000))

### comparing positive and negative points in study 1
pn <- data %>%
  filter(unique_group == "pointA22neg" | unique_group =="pointA22apos") %>%
  mutate(trial=scale(trial))

### model
mpn <- glmer(corr~ unique_group+ trial+
	(trial|id),
	data=pn, family=binomial, control = contr)

### model summary and p-values
summary (mpn)
drop1(mpn, test = "Chi")

```

# Study 2

For models we used all point data with negative emotional expression. Models represent different assumptions about developmental trajectories.
Quadratic model does not converge with maximal random effect structure, therefore correlation between random effects is removed.
```{r study 2}
### data
np <- data %>%
  filter(phase == "point" & type =="neg") %>%
  mutate(trial=scale(trial, center = TRUE, scale=TRUE), 
         unique_group = scale(as.numeric(unique_group), center = TRUE, scale=TRUE))

### linear
l <- glmer(corr~ unique_group+ trial+
	(trial||id),
	data=np, family=binomial, control = contr)

### model summary and p-values
summary (l)
drop1(l, test = "Chi")

### quadratic (u-shaped)
q <- glmer(corr~ unique_group+ I(unique_group^2)+ trial+
	(trial||id),
	data=np, family=binomial, control = contr)

### comapring models 
anova(l,q,test ="Chi")

### model summary and p-values
summary (q)
drop1(q, test = "Chi")

```

# Study 3

Using data from peek conditions. Different models represent different assumptions about developmental trajectories
```{r study 3}
## comparing performance across age
npe <- data %>%
  filter(phase == "peek" ) %>%
  mutate(trial=scale(trial), unique_group = scale(as.numeric(unique_group)))

### linear developmental trajectory
lp <- glmer(corr~ unique_group+ trial+
	(trial|id),
	data=npe, family=binomial, control = contr)

### model summary and p-values
summary (lp)
drop1(lp, test = "Chi")

### quadratic (u-shaped) trajectory, not plausible but for consistency sake
qp <- glmer(corr~ unique_group+ I(unique_group^2)+ trial+
	(trial|id),
	data=npe, family=binomial, control = contr)

### comapring models / quadratic model does not provide better fit
anova(lp,qp,test ="Chi")


```

# Plots

Overview of results.
```{r plot results}
ms <- data %>%
  group_by(unique_group,study,type, id) %>%
  summarise(correct = mean(corr)) %>%
  multi_boot_standard(col = "correct")

props <- data %>%
  group_by(id, type,unique_group,study, id) %>%
  summarise(corr = mean(corr))

source("geom_flat_violin.R")

ggplot()+
geom_count(data = props,aes(x = unique_group, y = corr), shape =21, stroke = .8, alpha = .8, position = position_nudge(-0.2))+
  geom_flat_violin(data = props, scale = "width",adjust = .7, trim = F, aes(x = unique_group, y = corr),position = position_nudge(0))+
  geom_hline(yintercept = 0.5, size = 0.5, lty=2)+
  scale_size_continuous(range = c(3,8))+
  guides(size=FALSE)+
  ylim(-0.05,1.05)+
  labs(x="Age in Month",y="Proportion Correct")+
  scale_colour_manual(name="Facial Expression",
                      labels=c("Positive", "Negative"), values=c("darkgreen", "firebrick"))+
  guides(colour = guide_legend(keywidth = 2, keyheight = 2))+
  scale_x_discrete(
    breaks = c("pointA22apos", "pointA22neg","pointA28neg","pointA34neg","pointA40neg","pointA46neg","peekA22neg","peekA28neg","peekA34neg"),
    labels= c("22", "22","28","34","40","46","22","28","34"))+
  facet_grid(.~ study, scales = "free_x", space = "free_x",
          labeller = as_labeller(c(`1`="Study 1 - Pointing", `2`="Study 2 - Pointing", `3`="Study 3 - Peeking")))+
  geom_point(data=ms,aes(x = unique_group, y = mean,colour = factor(type)), size = 4, stat="identity",position = position_nudge(-0.2)) + 
  geom_linerange(data = ms, aes(x = unique_group,colour = factor(type),y = mean, ymin = ci_lower, ymax = ci_upper), position = position_nudge(-0.2), size = 1.1) +
  theme(panel.border = element_rect(color = "black", fill = NA, size = 1))+
  theme_few()
```

By trial.

```{r plot trial}
ts <-  data %>%
  filter(type =="neg") %>%
  mutate(phase = ifelse(phase == "peek", "Peeking","Pointing")) %>%
  mutate(phase = as.factor(phase)) %>%
  mutate(age = recode(age, "A22"="22mo","A28"="28mo","A34"="34mo","A40"="40mo","A46"="46mo")) %>%
  mutate(phase = relevel(phase, ref = "Pointing")) %>%
  group_by(trial,age,phase,unique_group) %>%
  summarise(corr = mean(corr))
  

ggplot(ts, 
       aes(x = trial, y = corr, fill = age))+
  geom_point(aes(colour=factor(age)), size = 2)+
  geom_smooth(method = "lm", se = T , level = 0.95, aes(colour=factor(age)))+
  guides(fill=FALSE)+
  facet_grid(phase ~ age, drop = T)+
  scale_color_discrete(name="Age in month", labels=c("22","28","34","40","46"))+
  guides(color = F)+
  ylim(0,1)+
  geom_hline(yintercept = 0.5, size = 1, lty=2)+
  scale_x_continuous(breaks=c(1:8), labels = c(1:8))+
  labs(x="Trial",y="Proportion Correct")+
  theme_few()

```


